name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ===========================================================================
  # Backend: Python linting with Ruff
  # ===========================================================================
  lint-backend:
    name: Lint Backend (Ruff)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: "1.8.5"
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: services/backend/.venv
          key: venv-${{ runner.os }}-${{ hashFiles('services/backend/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-

      - name: Install dev dependencies
        run: poetry install --only dev

      - name: Run Ruff linter
        run: poetry run ruff check src/

      - name: Run Ruff formatter check
        run: poetry run ruff format --check src/

  # ===========================================================================
  # Frontend: ESLint + TypeScript
  # ===========================================================================
  lint-frontend:
    name: Lint Frontend (ESLint + TypeScript)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/frontend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: services/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate route tree
        run: npx @tanstack/router-cli generate

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript check
        run: npx tsc --noEmit

  # ===========================================================================
  # Backend: Unit tests
  # ===========================================================================
  test-backend-unit:
    name: Test Backend (Unit)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: "1.8.5"
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: services/backend/.venv
          key: venv-${{ runner.os }}-${{ hashFiles('services/backend/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Run unit tests
        run: poetry run pytest tests/swen/unit/ tests/swen_identity/unit/ -v

  # ===========================================================================
  # Frontend: Tests
  # ===========================================================================
  test-frontend:
    name: Test Frontend (Vitest)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/frontend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: services/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate route tree
        run: npx @tanstack/router-cli generate

      - name: Run tests
        run: npm run test

  # ===========================================================================
  # Backend: Integration tests (with PostgreSQL via Testcontainers)
  # ===========================================================================
  test-backend-integration:
    name: Test Backend (Integration)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: "1.8.5"
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: services/backend/.venv
          key: venv-${{ runner.os }}-${{ hashFiles('services/backend/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Run integration tests
        env:
          RUN_INTEGRATION: "1"
          # Test secrets (Testcontainers has Postgres: secrets are not used anywhere else)
          ENCRYPTION_KEY: "X6gejiP08L9cH4nW4bQk8aGo961x2rhGE40jOg67VwU="
          JWT_SECRET_KEY: "test-jwt-secret-for-ci"
          POSTGRES_PASSWORD: "test-password-not-used"
        run: poetry run pytest tests/swen/integration/ tests/swen_identity/integration/ tests/cross_domain/integration/ tests/cross_domain/e2e/ -v

  # ===========================================================================
  # Frontend: Build check
  # ===========================================================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/frontend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: services/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate route tree
        run: npx @tanstack/router-cli generate

      - name: Build
        run: npm run build
