name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ===========================================================================
  # Lock file integrity check
  # ===========================================================================
  check-lockfile:
    name: Check uv.lock is up to date
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Verify lock file is consistent with pyproject.toml
        run: uv lock --check

  # ===========================================================================
  # Backend: Python linting with Ruff
  # ===========================================================================
  lint-backend:
    name: Lint Backend (Ruff)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dev dependencies
        run: uv sync --group dev

      - name: Run Ruff linter
        run: uv run ruff check services/backend/src/

      - name: Run Ruff formatter check
        run: uv run ruff format --check services/backend/src/

  # ===========================================================================
  # Frontend: ESLint + TypeScript
  # ===========================================================================
  lint-frontend:
    name: Lint Frontend (ESLint + TypeScript)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/frontend

    steps:
      - uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: services/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate route tree
        run: npx @tanstack/router-cli generate

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript check
        run: npx tsc --noEmit

  # ===========================================================================
  # Backend: Unit tests
  # ===========================================================================
  test-backend-unit:
    name: Test Backend (Unit)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-packages

      - name: Run unit tests
        run: uv run pytest services/backend/tests/swen/unit/ services/backend/tests/swen_identity/unit/ -v

  # ===========================================================================
  # Frontend: Tests
  # ===========================================================================
  test-frontend:
    name: Test Frontend (Vitest)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/frontend

    steps:
      - uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: services/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate route tree
        run: npx @tanstack/router-cli generate

      - name: Run tests
        run: npm run test

  # ===========================================================================
  # Backend: Integration tests (with PostgreSQL via Testcontainers)
  # ===========================================================================
  test-backend-integration:
    name: Test Backend (Integration)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-packages

      - name: Run integration tests
        env:
          RUN_INTEGRATION: "1"
          # Test secrets (Testcontainers has Postgres: secrets are not used anywhere else)
          ENCRYPTION_KEY: "X6gejiP08L9cH4nW4bQk8aGo961x2rhGE40jOg67VwU="
          JWT_SECRET_KEY: "test-jwt-secret-for-ci"
          POSTGRES_PASSWORD: "test-password-not-used"
        run: uv run pytest services/backend/tests/swen/integration/ services/backend/tests/swen_identity/integration/ services/backend/tests/cross_domain/integration/ services/backend/tests/cross_domain/e2e/ -v

  # ===========================================================================
  # Frontend: Build check
  # ===========================================================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/frontend

    steps:
      - uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: services/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate route tree
        run: npx @tanstack/router-cli generate

      - name: Build
        run: npm run build
