# SWEN - Docker Compose with Traefik Labels
#
# This example shows how to add Traefik labels to SWEN containers.
# Use this as an overlay or merge into your main docker-compose.yml.
#
# Usage:
#   docker compose -f docker-compose.yml -f services/proxy/examples/docker-compose.traefik.yml up -d
#
# Prerequisites:
#   - Traefik running with Docker provider enabled
#   - Containers on the same Docker network as Traefik (e.g., "traefik" or "proxy")
#
# Adjust the network name below to match your Traefik setup.

services:
  backend:
    labels:
      # Enable Traefik
      - "traefik.enable=true"

      # API router
      - "traefik.http.routers.swen-api.rule=Host(`swen.example.com`) && PathPrefix(`/api`)"
      - "traefik.http.routers.swen-api.entrypoints=websecure"
      - "traefik.http.routers.swen-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.swen-api.middlewares=swen-headers@docker"

      # Health router
      - "traefik.http.routers.swen-health.rule=Host(`swen.example.com`) && Path(`/health`)"
      - "traefik.http.routers.swen-health.entrypoints=websecure"
      - "traefik.http.routers.swen-health.tls.certresolver=letsencrypt"

      # Service configuration
      - "traefik.http.services.swen-backend.loadbalancer.server.port=8000"
      - "traefik.http.services.swen-backend.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.swen-backend.loadbalancer.healthcheck.interval=30s"

      # Security headers middleware
      - "traefik.http.middlewares.swen-headers.headers.framedeny=true"
      - "traefik.http.middlewares.swen-headers.headers.contenttypenosniff=true"
      - "traefik.http.middlewares.swen-headers.headers.browserxssfilter=true"
      - "traefik.http.middlewares.swen-headers.headers.referrerpolicy=strict-origin-when-cross-origin"
    networks:
      - swenetwork
      - traefik  # Add your Traefik network here

  frontend:
    labels:
      # Enable Traefik
      - "traefik.enable=true"

      # Frontend router (catch-all, lower priority)
      - "traefik.http.routers.swen-frontend.rule=Host(`swen.example.com`)"
      - "traefik.http.routers.swen-frontend.entrypoints=websecure"
      - "traefik.http.routers.swen-frontend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.swen-frontend.priority=1"
      - "traefik.http.routers.swen-frontend.middlewares=swen-headers@docker"

      # Service configuration
      - "traefik.http.services.swen-frontend.loadbalancer.server.port=3000"
    networks:
      - swenetwork
      - traefik  # Add your Traefik network here

networks:
  traefik:
    external: true  # Assumes Traefik network already exists
